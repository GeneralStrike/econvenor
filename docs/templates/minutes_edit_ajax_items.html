{% load setclass %}

<form id="editminutesform" class="savebyjs" action="" method="POST">
  {% csrf_token %}

  <div class="panel panel-primary" id="meeting_details">
    <div class="panel-heading">
      <strong>Meeting details</strong>                
    </div>
    <div class="panel-body">
      {{ meeting_form}}
      <button type="button" title="Clear minutes" 
        class="btn btn-default ajax-button"
        id="clear_minutes">
          <i class="fa fa-times fa-lg"></i> Clear these minutes
      </button>
    </div>
  </div>
   
 
  {% for item in item_formlist %}
    
    <div class="panel panel-primary" id="panel_{{ item.item_no.value}}">
      
      <div class="panel-heading">
        {% ifequal item.added_in_meeting.value True %}
          <strong>Item&nbsp;{{ item.item_no.value }}.&nbsp;
                  {{ item.title|setclass:"form-control item-title" }}</strong>
          <div class="pull-right">
            <button type="button" title="Delete item" 
              class="btn btn-default btn-xs ajax-button tltip"
              id="delete_item_{{ item.item_no.value}}" data-toggle="tooltip" >
                <i class="fa fa-times fa-lg"></i> Delete
            </button>
          </div>
        {% else %}
          <strong>Item&nbsp;{{ item.item_no.value }}.&nbsp;
                  {{ item.title.value }}</strong>                
          <div class="pull-right">
            {{ item.time_limit.value }}&nbsp;minutes		
          </div>
        {% endifequal %}
      </div>
      
      <div class="panel-body">
      
        <div class="form-group">
          <div class="well well-sm">
            To be explained by&nbsp;{{ item.explainer.value }}
            <br/>
          </div>
        </div>
        
        <div class="form-group">
          {{ item.background.label_tag }}
          <div class="well">
            {{ item.background.value }}
          </div>
        </div>
        
        <div class="form-group">
          {{ item.minute_notes.label_tag }}
          {{ item.minute_notes|setclass:"form-control" }}
        </div>
        
        {% for hidden in item.hidden_fields %}
          <div class="form-group">
            {{ hidden }}
          </div>
        {% endfor %}


        <p><strong>Decisions:</strong></p>
        <div class="panel panel-default">
          {% for decision in decision_formlist %}
            {% ifequal decision.instance.item.id item.instance.id %}
              <div class="form-group">
                {{ decision.label_tag }}
                {{ decision.description|setclass:"form-control" }}
                <button type="button" title="Delete decision" 
                  class="btn btn-default btn-xs ajax-button tltip"
                  id="delete_decision_{{ decision.instance.id}}"
                  data-toggle="tooltip" >
                    <i class="fa fa-times fa-lg"></i> Delete
                </button>
              </div>
            {% endifequal %}
          {% endfor %}

          <button id="add_decision_{{ item.instance.id }}"
            class="btn btn-default ajax-button" type="button">
              Add a decision to this item
          </button>
          
        </div>


        <p><strong>Tasks:</strong></p>
        
        <div class="panel panel-default">
          {% for task in task_formlist %}
            {% ifequal task.instance.item.id item.instance.id %}
              <div class="form-inline" role="form">
                <div class="form-group">
                  {{ task.description|setclass:"form-control" }}
                  {{ task.participant|setclass:"form-control" }}
                  {{ task.deadline|setclass:"form-control datepicker" }}
                  <button type="button" title="Delete task" 
                  class="btn btn-default btn-xs ajax-button tltip"
                  id="delete_task_{{ task.instance.id}}"
                  data-toggle="tooltip" >
                    <i class="fa fa-times fa-lg"></i> Delete
                </button>
                </div>
              </div>
            {% endifequal %}
          {% endfor %}

          <button id="add_task_{{ item.instance.id }}"
            class="btn btn-default ajax-button" type="button">
            Add a task to this item
          </button>
        </div>						

      </div>
    </div>
  {% endfor %}
  
  
    <div class="panel panel-primary" id="next_meeting_details">
    <div class="panel-heading">
      <strong>Details of next meeting</strong>                
    </div>
    <div class="panel-body">
      {{ next_meeting_form}}
    </div>
  </div>
   
   
</form>


<script>

  $(function() {
  
    jQuery.validator.addMethod("timeCheck", function(value, element) {
      return this.optional(element) || /^([0-1]?[0-9]|[2][0-3]):([0-5][0-9])$/.test(value);
    },
    "Please select a time from the options available");

    $("#editminutesform").validate({
      rules: {
        date_actual: {
          required: true,
          date: true,
        },
        start_time_actual: {
          required: true,
          timeCheck: true,
        },
        end_time_actual: {
          required: true,
          timeCheck: true,
        },
        location_actual: {
          required: true,
          maxlength: 200,
        },
        facilitator_actual: "required",
        minute_taker_actual: "required",     
        attendance: "required",
        {% for item in item_formlist %}
          "{{ item.prefix }}-minute_notes": {
            required: true,
            maxlength: 5000,
          },
        {% endfor %}
        {% for decision in decision_formlist %}
          "{{ decision.prefix }}-description": {
            required: true,
            maxlength: 2000,
          },
        {% endfor %}
        {% for task in task_formlist %}
          "{{ task.prefix }}-description": {
            required: true,
            maxlength: 200,
          },
          "{{ task.prefix }}-participant": {
            required: true,
          },
          "{{ task.prefix }}-deadline": {
            required: true,
            date: true,
          },
        {% endfor %}
        next_meeting_date: {
          date: true,
        },
        next_meeting_start_time: {
          timeCheck: true,
        },
      },
      messages: {
        date_actual: {
          required: "Please select the date that the meeting happened",
          date: "Please select a valid date from the calendar",
        },
        start_time_actual: {
          required: "Please select the meeting's start time",
        },
        end_time_actual: {
          required: "Please select the meeting's end time",
        },
        location_actual: {
          required: "Please enter the location of the meeting", 
        },
        facilitator_actual: "Please select the meeting's facilitator",
        minute_taker_actual: "Please select the meeting's minute-taker",     
        attendance: "Please enter the names of the people at the meeting",
        {% for item in item_formlist %}
          "{{ item.prefix }}-minute_notes": {
            required: "Please enter this item's minutes"
          },
        {% endfor %}
        {% for decision in decision_formlist %}
          "{{ decision.prefix }}-description": {
            required: "Please enter the decision which was made",
          },
        {% endfor %}
        {% for task in task_formlist %}
          "{{ task.prefix }}-description": {
            required: "Please enter a description of the task",
          },
          "{{ task.prefix }}-participant": {
            required: "Please select the person responsible for this task",
          },
          "{{ task.prefix }}-deadline": {
            required: "Please select the deadline for this task",
            date: "Please select a valid date from the calendar",
          },
        {% endfor %}
        date_scheduled: {
          date: "Please select a valid date from the calendar",
        },
      },
      submitHandler: function(form) {
        $('body').css( 'cursor', 'wait' );
        var next_page = $("#submit_minutes").attr('goto');
        saveWithoutRefresh('ajax_button=save_minutes', next_page);
      },
    });

    $(document).on("click", "#submit_minutes", function(){     
      $( "#editminutesform" ).submit();
    });

  })

</script>

