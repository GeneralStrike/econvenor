{% load setclass %}

<form id="editagendaform" class="savebyjs" action="" method="POST">
{% csrf_token %}


<div class="panel panel-primary" id="meeting_details">
  <div class="panel-heading">
    Meeting details
  </div>
  <div class="panel-body">
    {{ meeting_form.errors }}
    {{ meeting_form.as_p }}
  </div>
</div>


{% for item in item_formlist %}

  <div class="panel panel-primary">
    
    <div class="panel-heading">
      {{ item.item_no.value }}
      {{ item.title|setclass:"form-control item-title" }}
      {{ item.title.errors }}
    </div>

    <div class="panel-body">
      {{ item.time_limit.label_tag }}
      {{ item.time_limit|setclass:"spinner" }}		
        {{ item.time_limit.errors }}
      {{ item.explainer.label_tag }}
      {{ item.explainer|setclass:"form-control" }}
        {{ item.explainer.errors }}
      {{ item.background.label_tag }}
      {{ item.background|setclass:"form-control" }}
        {{ item.background.errors }}
      <button type="button" title="Delete item" 
        class="btn btn-default btn-xs ajax-button tltip"
        id="delete_item_{{ item.item_no.value}}" data-toggle="tooltip" >
        <span class="glyphicon glyphicon-remove">Delete</span>
      </button>
    </div>
    
  </div>

{% endfor %}
</form>


<script>

  $(function() {

    jQuery.validator.addMethod("timeCheck", function(value, element) {
      return this.optional(element) || /^([0-1]?[0-9]|[2][0-3]):([0-5][0-9])$/.test(value);
    },
    "Please select a time from the options available");

    jQuery.validator.addMethod("meetingNumberCheck", function(value, element) {
      return this.optional(element) || /^[a-zA-Z0-9\-\_\/]+$/.test(value);
    },
    "The meeting number can only contain letters, numbers and these characters: '-', '_', '/'");

    $("#editagendaform").validate({
      rules: {
        meeting_no: {
          required: true,
          meetingNumberCheck: true,
        },
        meeting_type: "required",
        date_scheduled: {
          required: true,
          date: true,
        },
        start_time_scheduled: {
          required: true,
          timeCheck: true,
        },
        meeting_status: "required",
        {% for item in item_formlist %}
          "{{ item.prefix }}-title": "required",
          "{{ item.prefix }}-time_limit": {
            digits: true,
            range: [0, 600],
          },
        {% endfor %}
      },
      messages: {
        meeting_no: {
          required: "Please enter a number or code for this meeting",
        },
        meeting_type: "Please select the type of meeting that this is",
        date_scheduled: {
          required: "Please select a date for the meeting",
          date: "Please select a valid date from the calendar",
        },
        start_time_scheduled: {
          required: "Please select the meeting's start time",        
        },
        meeting_status: "Please select the current status of the meeting",
        {% for item in item_formlist %}
          "{{ item.prefix }}-title": "Please enter a title for this agenda item",
          "{{ item.prefix }}-time_limit": {
            digits: "Please enter a number between 0 and 600",
            range: "Please enter a number between 0 and 600",
          },
        {% endfor %}
      },
      submitHandler: function(form) {
        $('body').css( 'cursor', 'wait' );
        var next_page = $("#submit_agenda").attr('goto');
        saveWithoutRefresh('ajax_button=save_agenda', next_page);
      },
    });
  })

  $(document).on("click", "#submit_agenda", function(){     
    $( "#editagendaform" ).submit();
  });

</script>

